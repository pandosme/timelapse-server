const ClientDigestAuth = require('./build/main/lib/client-digest-auth').ClientDigestAuth;

const got = require('got');
(async () => {
  const context = {
    token: 'secret'
  };

 function createDigestClient(username, password) {
    return got.extend({
      hooks: {
        afterResponse: [
          (res, retry) => {
            const options = res.request.options;
            const digestHeader = res.headers["www-authenticate"];

            if (!digestHeader) {
              return res;
            }

            const incomingDigest = ClientDigestAuth.analyze(digestHeader);

            console.log(incomingDigest);

            const digest = ClientDigestAuth.generateProtectionAuth(
              incomingDigest,
              username,
              password,
              {
                method: options.method,
                uri: options.url.pathname,
                counter: 1
              }
            );

            options.headers.authorization = digest.raw;

            return retry(options);
          }
        ],
        beforeRetry: [
          (options, error, retryCount) => {
            console.log(options.headers, error, retryCount);
          }
        ]
      }
    });
  }

  const response = await createDigestClient('testdigest', '12345678').post('http://127.0.0.1:18082/json_rpc/', {json: {"jsonrpc":"2.0","id":"0","method":"make_integrated_address"}, responseType: 'json'}).catch(console.log);
  console.log(response);
})();

// Digest username="postman", realm="{{echo_digest_realm}}", nonce="{{echo_digest_nonce}}", uri="/digest-auth", algorithm="MD5-sess", qop=auth, nc=00000001, cnonce="NCSqNLln", response="e29f6e2187fe04effda84a81885cdb14"
